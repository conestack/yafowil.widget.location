var yafowil_location=function(t,i){"use strict";class a{constructor(t,i){this.widget=t,this.marker=i,this.create_popup()}create_popup(){let t=document.createElement("a");t.href="#",t.innerHTML="Remove",t.onclick=this.remove_handle.bind(this),this.marker.bindPopup(t)}remove_handle(){let t=this.widget;return t.markers.removeLayer(this.marker),t.lat="",t.lon="",t.zoom="",!1}}class e{constructor(t,i,e){this.widget=t;let o=new L.Marker([i,e],{draggable:!0});o.addTo(t.markers),this.widget.disable_interaction||(new a(t,o),o.on("dragend",this.dragend_handle.bind(this)))}dragend_handle(t){let i=t.target._latlng,a=this.widget;a.lat=i.lat,a.lon=i.lng,a.zoom=a.map.getZoom()}}class o{constructor(t){this.widget=t;let i=this.geosearch=new GeoSearch.GeoSearchControl({provider:new GeoSearch.OpenStreetMapProvider,style:"bar",autoClose:!0});t.map.addControl(i),t.map.on("geosearch/showlocation",this.showloaction_handle.bind(this))}showloaction_handle(t){let i=t.location,a=i.y,e=i.x,o=this.widget;o.markers.clearLayers(),this.widget.create_marker(a,e),o.lat=a,o.lon=e}}class n{static initialize(t){i("div.location-map",t).each((function(){if(void 0!==window.yafowil_array&&window.yafowil_array.inside_template(i(this)))return;let t={disable_interaction:i(this).data("disable_interaction")};new n(i(this),t)}))}constructor(t,a){t.data("yafowil-location",this),this.elem=t,this.disable_interaction=a.disable_interaction,this.id=t.attr("id");let e=t.parent();this._input_lat=i("input.location-lat",e),this._input_lon=i("input.location-lon",e),this._input_zoom=i("input.location-zoom",e),this.change_lat_handle=this.change_lat_handle.bind(this),this._input_lat.on("change",this.change_lat_handle),this.change_lon_handle=this.change_lon_handle.bind(this),this._input_lon.on("change",this.change_lon_handle),this.min_zoom=t.data("min_zoom"),this.max_zoom=t.data("max_zoom"),this.tile_layers=t.data("tile_layers"),this._lat=t.data("lat"),this._lon=t.data("lon"),this._zoom=t.data("zoom"),this.value=this.elem.data("value"),this.create_map(),this.disable_interaction||new o(this)}get value(){return this._value}set value(t){this._value=t,t&&(void 0!==t.lat&&void 0!==t.lon&&(this._lat=t.lat,this._lon=t.lon),void 0!==t.zoom&&(this._zoom=t.zoom))}get lat(){return this._lat}set lat(t){this._lat=t,this._input_lat.val(t)}get lon(){return this._lon}set lon(t){this._lon=t,this._input_lon.val(t)}get zoom(){return this._zoom}set zoom(t){this._zoom=t,this._input_zoom.val(t)}create_marker(t,i){return new e(this,t,i)}create_map(){let t=this.map=new L.Map(this.id);this.map.setView([this.lat,this.lon],this.zoom);for(let i of this.tile_layers)i.options.minZoom=this.min_zoom,i.options.maxZoom=this.max_zoom,new L.TileLayer(i.urlTemplate,i.options).addTo(t);let i=this.markers=new L.FeatureGroup;t.addLayer(i),this.value&&this.create_marker(this.lat,this.lon),t.on("click",this.click_handle.bind(this))}click_handle(t){if(this.disable_interaction)return;this.markers.clearLayers();let i=t.latlng;this.create_marker(i.lat,i.lng),this.lat=i.lat,this.lon=i.lng,this.zoom=this.map.getZoom()}change_val(t,i){if(this.disable_interaction)return;let a=parseFloat(t.val());isNaN(a)?t.val(this[i]):(this[i]=a,this.markers.clearLayers(),this.create_marker(this.lat,this.lon),this.map.setView([this.lat,this.lon],this.zoom))}change_lat_handle(t){t.preventDefault(),this.change_val(i(t.currentTarget),"_lat")}change_lon_handle(t){t.preventDefault(),this.change_val(i(t.currentTarget),"_lon")}}function l(t,i){n.initialize(i)}function s(){void 0!==window.yafowil_array&&window.yafowil_array.on_array_event("on_add",l)}return i((function(){void 0!==window.ts?ts.ajax.register(n.initialize,!0):void 0!==window.bdajax?bdajax.register(n.initialize,!0):n.initialize(),s()})),t.LocationWidget=n,t.LocationWidgetMarker=e,t.LocationWidgetMarkerPopup=a,t.LocationWidgetSearch=o,t.register_array_subscribers=s,Object.defineProperty(t,"__esModule",{value:!0}),window.yafowil=window.yafowil||{},window.yafowil.location=t,t}({},jQuery);
